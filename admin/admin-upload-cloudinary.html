<!doctype html>
<meta charset="utf-8">
<title>多張拼貼照 上傳＋manifest JSON 產生器</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex,nofollow">
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
  :root{--blue:#2563eb;--ok:#16a34a;--muted:#64748b}
  body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Arial;margin:24px;color:#0b1220}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem .9rem;border-radius:.55rem;background:var(--blue);color:#fff;border:0;cursor:pointer;font-weight:700}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#0f172a;color:#e5e7eb}
  input,select{width:100%;padding:.55rem .7rem;border:1px solid #cbd5e1;border-radius:.5rem}
  label{display:block;margin:.5rem 0 .25rem;font-weight:600}
  .badge{display:inline-block;padding:.2rem .5rem;border-radius:.5rem;background:#e2e8f0;margin-left:.5rem;font-size:.8rem}
  .note{background:#f1f5f9;border-left:4px solid var(--blue);padding:.75rem 1rem;border-radius:.5rem;margin:.5rem 0 1rem}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{border:1px solid #e5e7eb;border-radius:.6rem;padding:8px}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:.4rem;border:1px solid #e5e7eb;background:#f8fafc}
  .rowbtn{display:flex;gap:6px;margin-top:6px}
  .gray{background:#0f172a;color:#e5e7eb;padding:12px;border-radius:.6rem;white-space:pre;overflow:auto;border:1px solid #1f2937}
</style>

<h1>多張拼貼照 上傳＋manifest JSON 產生器</h1>
<p class="note">
  Cloud name = <b>dijzndzw2</b>、Unsigned preset = <b>nu-unsigned</b>、Folder = <b>natural-uncle</b>。<br>
  一筆案例可上傳 <b>2–6 張「拼貼照」</b>，排序可調整；完成後產生 <code>images: []</code> 陣列並一鍵複製。
</p>

<div class="row">
  <section>
    <label>Cloud Name</label>
    <input id="cloudName" value="dijzndzw2" readonly>
    <label>Unsigned Upload Preset</label>
    <input id="preset" value="nu-unsigned" readonly>
    <label>Folder（可改）</label>
    <input id="folder" value="natural-uncle">

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnUpload">上傳拼貼照（可多選）</button>
      <span class="badge"><span id="count">0</span> 張</span>
      <button class="btn btn-ghost" id="btnClear" type="button">清空</button>
    </div>

    <div style="margin-top:12px">
      <div class="grid" id="grid"></div>
      <p class="muted" id="hint" style="margin-top:8px">建議 2–6 張；第一張放最具代表性的對比照。</p>
    </div>

    <label style="margin-top:16px">日期（YYYY-MM-DD）</label>
    <input id="date" placeholder="例如：2025-09-03">
    <label>服務</label>
    <select id="service">
      <option>冷氣</option><option>洗衣機</option><option>水塔</option><option>水管</option>
    </select>
    <label>城市</label><input id="city" placeholder="例如：台北市">
    <label>行政區</label><input id="area" placeholder="例如：大安區">
    <label>備註</label><input id="note" placeholder="選填：現場狀況 / 成果重點">

    <button class="btn" id="gen" style="margin-top:12px">產生 JSON 片段</button>
  </section>

  <section>
    <label>結果（複製貼回 works/manifest.json 陣列中）</label>
    <div style="display:flex;align-items:center;gap:8px;margin:8px 0">
      <button class="btn" id="copyBtn" disabled>📋 一鍵複製</button>
      <span id="copyStatus" class="muted"></span>
    </div>
    <textarea id="out" class="gray" rows="22" readonly></textarea>
  </section>
</div>

<script>
/* 預設日期 = 今天 */
(function(){ const t=new Date(); const pad=n=>n<10?'0'+n:n; document.getElementById('date').value = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`; })();

/* ===== Cloudinary 多張上傳（收集 public_id 陣列） ===== */
let uploaded = []; // [{pid, urlThumb, urlFull}]

function buildCloudinaryUrl(cloudName, publicId, w){
  const safePath = publicId.split('/').map(encodeURIComponent).join('/'); // 分段編碼
  return `https://res.cloudinary.com/${cloudName}/image/upload/f_auto,q_auto,w_${w}/${safePath}`;
}

function renderGrid(){
  const grid = document.getElementById('grid');
  const cloud = document.getElementById('cloudName').value.trim();
  document.getElementById('count').textContent = uploaded.length;

  if(uploaded.length===0){ grid.innerHTML=''; return; }

  grid.innerHTML = uploaded.map((x, i)=>{
    const thumb = x.urlThumb || buildCloudinaryUrl(cloud, x.pid, 800);
    return `
      <div class="card">
        <img class="thumb" src="${thumb}" alt="拼貼照 ${i+1}">
        <div class="rowbtn">
          <button class="btn" data-act="up" data-i="${i}" ${i===0?'disabled':''}>↑</button>
          <button class="btn" data-act="down" data-i="${i}" ${i===uploaded.length-1?'disabled':''}>↓</button>
          <button class="btn" data-act="del" data-i="${i}" style="background:#ef4444">刪除</button>
        </div>
      </div>`;
  }).join('');

  grid.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.i, act = btn.dataset.act;
      if(act==='del'){ uploaded.splice(i,1); renderGrid(); return; }
      if(act==='up' && i>0){ [uploaded[i-1],uploaded[i]]=[uploaded[i],uploaded[i-1]]; renderGrid(); return; }
      if(act==='down' && i<uploaded.length-1){ [uploaded[i+1],uploaded[i]]=[uploaded[i],uploaded[i+1]]; renderGrid(); return; }
    };
  });
}

function openWidget(){
  const cloudName = document.getElementById('cloudName').value.trim();
  const preset = document.getElementById('preset').value.trim();
  const folder = document.getElementById('folder').value.trim();

  const widget = cloudinary.createUploadWidget({
    cloudName, uploadPreset: preset, folder: folder || undefined,
    multiple: true, maxFiles: 6,
    sources: ['local','camera','url','google_drive'],
    clientAllowedFormats: ['jpg','jpeg','png','webp','heic'],
    maxFileSize: 15 * 1024 * 1024
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      const pid = result.info.public_id;
      uploaded.push({ pid });
      if(uploaded.length>6){ uploaded = uploaded.slice(0,6); alert('最多 6 張，已截斷。'); }
      renderGrid();
    }
  });
  widget.open();
}

document.getElementById('btnUpload').onclick = openWidget;
document.getElementById('btnClear').onclick = ()=>{ uploaded=[]; renderGrid(); };

/* ===== 產生 JSON：images 陣列 ===== */
function buildEntry(pids){
  const pad = n => n<10? '0'+n : ''+n;
  const t = new Date(); const today = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
  const id = `${today}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
  return {
    id,
    date: document.getElementById('date').value || today,
    service: document.getElementById('service').value,
    city: document.getElementById('city').value || '',
    area: document.getElementById('area').value || '',
    note: document.getElementById('note').value || '',
    provider: 'cloudinary',
    images: pids
  };
}

document.getElementById('gen').onclick = ()=>{
  if(uploaded.length<2){ alert('請至少上傳 2 張拼貼照'); return; }
  const pids = uploaded.map(x=>x.pid);
  const obj = buildEntry(pids);
  document.getElementById('out').value = JSON.stringify(obj, null, 2);
  document.getElementById('copyBtn').disabled = false;
  document.getElementById('copyStatus').textContent = '';
};

/* 一鍵複製 */
document.getElementById('copyBtn').onclick = async ()=>{
  const text = document.getElementById('out').value.trim();
  if(!text){ alert('沒有可複製的內容'); return; }
  try{
    await navigator.clipboard.writeText(text);
    document.getElementById('copyStatus').textContent = '✅ 已複製到剪貼簿';
    setTimeout(()=>document.getElementById('copyStatus').textContent='', 1800);
  }catch{
    document.getElementById('copyStatus').textContent = '❌ 複製失敗（瀏覽器限制）';
  }
};
</script>
